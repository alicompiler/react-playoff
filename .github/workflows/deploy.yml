name: Deploy Demo

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: npm ci

      - name: Run Tests with Coverage
        run: npm run test:coverage

      - name: Build Demo
        run: npm run build:demo

      - name: Generate Coverage Badge JSON
        run: |
          node -e "
          const fs = require('fs');
          const path = './coverage/coverage-summary.json';
          if (!fs.existsSync(path)) {
            console.error('Coverage summary not found!');
            process.exit(1);
          }
          const summary = JSON.parse(fs.readFileSync(path));
          const pct = summary.total.statements.pct;
          const color = pct >= 90 ? 'brightgreen' : pct >= 80 ? 'green' : pct >= 70 ? 'yellowgreen' : pct >= 60 ? 'yellow' : 'red';
          const badge = {
            schemaVersion: 1,
            label: 'coverage',
            message: \`\${pct}%\`,
            color: color
          };
          if (!fs.existsSync('./dist-demo')) fs.mkdirSync('./dist-demo', { recursive: true });
          fs.writeFileSync('./dist-demo/coverage-badge.json', JSON.stringify(badge));
          "

      - name: Deploy
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist-demo
          branch: gh-pages
